# groovy table

INSERT INTO groovy (groovy_id, java_class, script_crc32, script, system)
VALUES
  ('com.angkorteam.mbaas.server.page.DashboardPage',
   'com.angkorteam.mbaas.server.page.DashboardPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.menu.MenuBrowsePage',
   'com.angkorteam.mbaas.server.page.menu.MenuBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.menu.MenuCreatePage',
   'com.angkorteam.mbaas.server.page.menu.MenuCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.menu.MenuModifyPage',
   'com.angkorteam.mbaas.server.page.menu.MenuModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.menuitem.MenuItemBrowsePage',
   'com.angkorteam.mbaas.server.page.menuitem.MenuItemBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.menuitem.MenuItemCreatePage',
   'com.angkorteam.mbaas.server.page.menuitem.MenuItemCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.menuitem.MenuItemModifyPage',
   'com.angkorteam.mbaas.server.page.menuitem.MenuItemModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.section.SectionBrowsePage',
   'com.angkorteam.mbaas.server.page.section.SectionBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.section.SectionCreatePage',
   'com.angkorteam.mbaas.server.page.section.SectionCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.section.SectionModifyPage',
   'com.angkorteam.mbaas.server.page.section.SectionModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.layout.LayoutBrowsePage',
   'com.angkorteam.mbaas.server.page.layout.LayoutBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.layout.LayoutCreatePage',
   'com.angkorteam.mbaas.server.page.layout.LayoutCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.layout.LayoutModifyPage',
   'com.angkorteam.mbaas.server.page.layout.LayoutModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.page.PageModifyPage',
   'com.angkorteam.mbaas.server.page.page.PageModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.page.PageCreatePage',
   'com.angkorteam.mbaas.server.page.page.PageCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.page.PageBrowsePage',
   'com.angkorteam.mbaas.server.page.page.PageBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.page.RoleModifyPage',
   'com.angkorteam.mbaas.server.page.page.RoleModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.role.RoleCreatePage',
   'com.angkorteam.mbaas.server.page.role.RoleCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.role.RoleBrowsePage',
   'com.angkorteam.mbaas.server.page.role.RoleBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.collection.CollectionBrowsePage',
   'com.angkorteam.mbaas.server.page.collection.CollectionBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.collection.CollectionCreatePage',
   'com.angkorteam.mbaas.server.page.collection.CollectionCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.attribute.AttributeCreatePage',
   'com.angkorteam.mbaas.server.page.attribute.AttributeCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.attribute.AttributeBrowsePage',
   'com.angkorteam.mbaas.server.page.attribute.AttributeBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.document.DocumentBrowsePage',
   'com.angkorteam.mbaas.server.page.document.DocumentBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.document.DocumentCreatePage',
   'com.angkorteam.mbaas.server.page.document.DocumentCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.document.DocumentModifyPage',
   'com.angkorteam.mbaas.server.page.document.DocumentModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.file.FileModifyPage',
   'com.angkorteam.mbaas.server.page.file.FileModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.file.FileCreatePage',
   'com.angkorteam.mbaas.server.page.file.FileCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.file.FileBrowsePage',
   'com.angkorteam.mbaas.server.page.file.FileBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.user.UserBrowsePage',
   'com.angkorteam.mbaas.server.page.user.UserBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.user.UserCreatePage',
   'com.angkorteam.mbaas.server.page.user.UserCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.user.UserModifyPage',
   'com.angkorteam.mbaas.server.page.user.UserModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.user.UserPasswordPage',
   'com.angkorteam.mbaas.server.page.user.UserPasswordPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.LoginPage',
   'com.angkorteam.mbaas.server.page.LoginPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.LogoutPage',
   'com.angkorteam.mbaas.server.page.LogoutPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.rest.RestBrowsePage',
   'com.angkorteam.mbaas.server.page.rest.RestBrowsePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.rest.RestCreatePage',
   'com.angkorteam.mbaas.server.page.rest.RestCreatePage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.page.rest.RestModifyPage',
   'com.angkorteam.mbaas.server.page.rest.RestModifyPage', NULL, '', TRUE),
  ('com.angkorteam.mbaas.server.groovy.EmptyLayout', 'com.angkorteam.mbaas.server.groovy.EmptyLayout', 1735006089, 'package com.angkorteam.mbaas.server.groovy
import com.angkorteam.mbaas.server.page.CmsLayout
import org.slf4j.Logger
import org.slf4j.LoggerFactory

class EmptyLayout extends CmsLayout {

    private static final Logger LOGGER = LoggerFactory.getLogger(EmptyLayout.class)

    EmptyLayout(String id) {
        super(id)
    }

    @Override
    protected void doInitialize() {
        // place your initialization logic here
    }

    @Override
    final String getLayoutUUID () {
        // DO NOT MODIFIED
        return "com.angkorteam.mbaas.server.groovy.EmptyLayout"
    }

}',
   FALSE),
  ('com.angkorteam.mbaas.server.groovy.SettingPage', 'com.angkorteam.mbaas.server.groovy.SettingPage', 548400907, 'package com.angkorteam.mbaas.server.groovy

import com.angkorteam.framework.extension.wicket.ajax.markup.html.form.AjaxButton
import com.angkorteam.framework.extension.wicket.markup.html.form.select2.Select2SingleChoice
import com.angkorteam.framework.extension.wicket.markup.html.panel.TextFeedbackPanel
import com.angkorteam.mbaas.server.Spring
import com.angkorteam.mbaas.server.page.CmsPage
import com.angkorteam.mbaas.server.select2.Item
import com.angkorteam.mbaas.server.select2.JdbcSingleChoiceProvider
import org.apache.wicket.ajax.AjaxRequestTarget
import org.apache.wicket.lambda.WicketBiConsumer
import org.apache.wicket.markup.html.border.Border
import org.apache.wicket.markup.html.form.Form
import org.apache.wicket.model.PropertyModel
import org.slf4j.Logger
import org.slf4j.LoggerFactory
import org.sql2o.Connection
import org.sql2o.Query
import org.sql2o.Sql2o

class SettingPage extends CmsPage {

    private static final Logger LOGGER = LoggerFactory.getLogger(SettingPage.class)

    Item homePage
    Select2SingleChoice<Item> homePageField
    TextFeedbackPanel homePageFeedback

    AjaxButton saveButton
    Form<Void> form

    @Override
    protected void doInitialize(Border layout) {
        add(layout)
        // place your initialization logic here

        this.form = new Form<>("form")
        layout.add(this.form)

        this.homePageField = new Select2SingleChoice<>("homePageField", new PropertyModel<Item>(this, "homePage"), new JdbcSingleChoiceProvider("page", "page_id", "title"))
        this.homePageField.setRequired(true)
        this.form.add(this.homePageField)
        this.homePageFeedback = new TextFeedbackPanel("homePageFeedback", this.homePageField)
        this.form.add(this.homePageFeedback)

        this.saveButton = new AjaxButton("saveButton")
        this.saveButton.setOnError(saveButtonError)
        this.saveButton.setOnSubmit(saveButtonSubmit)
        this.form.add(this.saveButton)

        Sql2o sql2o = Spring.getBean(Sql2o.class)
        Connection connection = sql2o.open()
        connection.withCloseable {
            loadSetting(connection)
        }
    }

    void loadSetting(Connection connection) {
        loadHomePage(connection)
    }

    void loadHomePage(Connection connection) {
        Query query = connection.createQuery("SELECT page.page_id id, page.title value FROM setting INNER JOIN page on setting.value = page.page_id where name = :name")
        query.addParameter("name", "home_page")
        this.homePage = query.executeAndFetchFirst(Item.class)
    }

    def saveButtonSubmit = { AjaxButton button, AjaxRequestTarget target ->
        saveHomePage()
        setResponsePage(SettingPage.class)
    } as WicketBiConsumer<AjaxButton, AjaxRequestTarget>

    void saveHomePage() {
        Sql2o sql2o = Spring.getBean(Sql2o.class)
        Connection connection = sql2o.beginTransaction()
        connection.withCloseable {
            Query query = connection.createQuery("UPDATE setting set value = :value where name = :name")
            query.addParameter("name", "home_page")
            query.addParameter("value", this.homePage.getId())
            query.executeUpdate()
            connection.commit()
        }
    }

    def saveButtonError = { AjaxButton button, AjaxRequestTarget target ->
        target.add(form)
    } as WicketBiConsumer<AjaxButton, AjaxRequestTarget>

    @Override
    final String getPageUUID() {
        // DO NOT MODIFIED
        return "com.angkorteam.mbaas.server.groovy.SettingPage"
    }

}', FALSE);

